#!/bin/bash
#Â Actions to run before the main and shared deployment actions.
# It can be useful to backup, import databases or doing something similar.
# Available variables are defined in settings.sh.

# Return error codes if they happen.
set -e

if [ "$COMBAWA_FETCH_DB_DUMP" == "1" ] ; then
  echo -e "${BLUE}Updating the reference dump.${NC}"
  if [ -z "$COMBAWA_SSH_CONFIG_NAME" ]; then
    echo -e "${YELLOW}Copying locally the dump file.${NC}"
    cp $COMBAWA_PROD_DB_DUMP_PATH "$APP_ROOT/$COMBAWA_DUMP_FILE_NAME.gz"
    echo -e "${GREEN}Done!${NC}"
  else
    echo -e "${YELLOW}Fetching the dump from remote source...${NC}"
    scp $COMBAWA_SSH_CONFIG_NAME:$COMBAWA_PROD_DB_DUMP_PATH "$APP_ROOT/$COMBAWA_DUMP_FILE_NAME.gz"
    echo -e "${GREEN}Done!${NC}"
  fi
  if [[ $? != 0 ]]; then
    echo -e "${RED}Impossible to retrieve the dump file. Verify the file name.${NC}"
    exit 1
  fi
fi

case $COMBAWA_ENV in
  dev)
    # In update mode, load the reference dump if it exists.
    if [ "$COMBAWA_BUILD_MODE" == "update" ]; then
      if [ -f "$APP_ROOT/$COMBAWA_DUMP_FILE_NAME.gz" ]; then
        $DRUSH sql-drop -y;
        echo -e "${GREEN}DB drop... OK!${NC}"
        echo -e ""

        echo -e "${BLUE}Importing the new DB...${NC}"
        echo -e "${YELLOW}Decompressing file...${NC}"
        gzip -dkf $APP_ROOT/$COMBAWA_DUMP_FILE_NAME.gz
        echo -e "${GREEN}Done!${NC}"
        pv --progress --name 'DB Import in progress' -tea "$APP_ROOT/$COMBAWA_DUMP_FILE_NAME" | $DRUSH sqlc
        echo -e "${GREEN}Done!${NC}"
        echo -e "${YELLOW}Removing tempory sql file...${NC}"
        rm -f $APP_ROOT/$COMBAWA_DUMP_FILE_NAME
        echo -e "${GREEN}Done!${NC}"
        echo -e "${GREEN}DB import... OK!${NC}"
        echo -e ""
      else
        echo "${RED}Database reference dump $APP_ROOT/$COMBAWA_DUMP_FILE_NAME.gz not found.${NC}"
        exit 1;
      fi
    fi
    ;;
  recette|preprod)
    # In update mode, load the reference dump if it exists.
    if [ "$COMBAWA_BUILD_MODE" == "update" ]; then
      if [ -f "$APP_ROOT/$COMBAWA_DUMP_FILE_NAME.gz" ]; then
        $DRUSH sql-drop -y;
        echo -e "${GREEN}DB drop... OK!${NC}"
        echo -e ""

        echo -e "${BLUE}Importing the new DB...${NC}"
        echo -e "${YELLOW}Decompressing file...${NC}"
        gzip -dkf $APP_ROOT/$COMBAWA_DUMP_FILE_NAME.gz
        echo -e "${GREEN}Done!${NC}"
        pv --progress --name 'DB Import in progress' -tea "$APP_ROOT/$COMBAWA_DUMP_FILE_NAME" | $DRUSH sqlc
        echo -e "${GREEN}Done!${NC}"
        echo -e "${YELLOW}Removing tempory sql file...${NC}"
        rm -f $APP_ROOT/$COMBAWA_DUMP_FILE_NAME
        echo -e "${GREEN}Done!${NC}"
        echo -e "${GREEN}DB import... OK!${NC}"
        echo -e ""
      else
        echo "${RED}Database reference dump $APP_ROOT/$COMBAWA_DUMP_FILE_NAME.gz not found.${NC}"
        exit 1;
      fi
    fi
    ;;
  prod)
    ;;
  *)
    echo -e "${RED}Unknown environment: $COMBAWA_ENV. Please check your name.${NC}"
    exit 1;
esac
